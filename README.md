# Документация Ansible Playbook для установки Vector

## Описание

Этот Ansible playbook выполняет установку и настройку [Vector](https://vector.dev/) - высокопроизводительного инструмента для наблюдения за данными и их передачи.

## Переменные

Обязательные переменные:
- `vector_version` - версия Vector для установки (например, "0.34.0")
- `vector_install_dir` - директория для установки файлов Vector (по умолчанию рекомендуется "/opt/vector")
- `vector_config_path` - путь к файлу конфигурации Vector (по умолчанию "/etc/vector/vector.toml")

## Задачи

### 1. Установка зависимостей
Устанавливает необходимые пакеты только на Debian-системах:
- `wget` - для загрузки файлов
- `tar` - для работы с архивами
- `gzip` - для распаковки архивов

### 2. Создание директории для установки
Создает директорию для установки Vector с правами 0755.

### 3. Загрузка Vector
Скачивает архив Vector с официального сайта:
- URL формируется динамически на основе указанной версии
- Сохраняет архив в `/tmp/vector.tar.gz`

### 4. Распаковка Vector
Распаковывает архив в целевую директорию:
- Использует `--strip-components=1` для удаления лишнего уровня вложенности
- Проверяет наличие бинарного файла после распаковки

### 5. Установка бинарного файла Vector
Копирует исполняемый файл vector в `/usr/local/bin/`:
- Устанавливает права 0755
- Владельца и группу root:root

### 6. Проверка бинарного файла
Проверяет наличие и права бинарного файла.

### 7. Создание системной группы
Создает системную группу `vector`.

### 8. Создание системного пользователя
Создает системного пользователя `vector`:
- Без shell (`/bin/false`)
- С домашней директорией `/var/lib/vector`
- В группе `vector`

### 9. Добавление пользователя в группу adm
Добавляет пользователя vector в группу adm для доступа к логам.

### 10. Создание рабочих директорий
Создает необходимые директории:
- `/etc/vector` - для конфигурационных файлов
- `/var/lib/vector` - для данных
- `/var/log/vector` - для логов
Устанавливает владельца vector:vector и права 0755.

### 11. Развертывание конфигурации
Копирует конфигурационный файл из шаблона `vector.toml`:
- В целевое расположение `{{ vector_config_path }}`
- С правами 0640
- Владельцем vector:vector

### 12. Развертывание systemd-сервиса
Копирует unit-файл systemd из шаблона `vector.service.j2`:
- В `/etc/systemd/system/vector.service`
- С правами 0644

### 13. Перезагрузка systemd
Выполняет `daemon-reload` для systemd.

### 14. Запуск и включение сервиса
Запускает сервис vector и включает его автозагрузку.

### 15. Проверка установки
Проверяет версию Vector и выводит ее.

### 16. Проверка статуса сервиса
Проверяет статус сервиса vector.

## Требования

- Ansible 2.9+
- Debian/Ubuntu система (для apt-установки)
- Доступ в интернет для загрузки Vector
- Права root/sudo

## Использование

Пример вызова playbook:
```bash
ansible-playbook install_vector.yml \
  -e "vector_version=0.34.0" \
  -e "vector_install_dir=/opt/vector" \
  -e "vector_config_path=/etc/vector/vector.toml"
```

## Необходимые шаблоны

1. `vector.toml` - конфигурационный файл Vector
2. `vector.service.j2` - unit-файл для systemd

## Примечания

- Для других дистрибутивов потребуется адаптация (использование yum вместо apt)
- Перед использованием необходимо подготовить конфигурационные шаблоны
- Vector будет запущен под системным пользователем vector с ограниченными правами